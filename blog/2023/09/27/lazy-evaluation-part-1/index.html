<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.117.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/MeshFreeFoam-Docs/favicons/favicon.ico><link rel=apple-touch-icon href=/MeshFreeFoam-Docs/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/MeshFreeFoam-Docs/favicons/android-192x192.png sizes=192x192><title>Lazy Evaluation: Part 1 | MeshFreeFoam API Docs</title><meta name=description content="In this short post, I examine the feasibility of implementing lazily-evaluated operations for MeshFreeFoam, contrasting them with the default eager evaluation used for OpenFOAM fields. Given the time constraints of my PhD project, performance is no longer the only concern. Multiple factors, including code maintainability, must be taken into account.&#34;
"><meta property="og:title" content="Lazy Evaluation: Part 1"><meta property="og:description" content="In this short post, I examine the feasibility of implementing lazily-evaluated operations for MeshFreeFoam, contrasting them with the default eager evaluation used for OpenFOAM fields. Given the time constraints of my PhD project, performance is no longer the only concern. Multiple factors, including code maintainability, must be taken into account.&#34;
"><meta property="og:type" content="article"><meta property="og:url" content="https://foamscience.github.io/MeshFreeFoam-Docs/blog/2023/09/27/lazy-evaluation-part-1/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-09-27T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-29T22:04:56+02:00"><meta property="og:site_name" content="API docs for MeshFreeFoam"><meta itemprop=name content="Lazy Evaluation: Part 1"><meta itemprop=description content="In this short post, I examine the feasibility of implementing lazily-evaluated operations for MeshFreeFoam, contrasting them with the default eager evaluation used for OpenFOAM fields. Given the time constraints of my PhD project, performance is no longer the only concern. Multiple factors, including code maintainability, must be taken into account.&#34;
"><meta itemprop=datePublished content="2023-09-27T00:00:00+00:00"><meta itemprop=dateModified content="2023-09-29T22:04:56+02:00"><meta itemprop=wordCount content="1246"><meta itemprop=keywords content="c++,performance,openfoam,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lazy Evaluation: Part 1"><meta name=twitter:description content="In this short post, I examine the feasibility of implementing lazily-evaluated operations for MeshFreeFoam, contrasting them with the default eager evaluation used for OpenFOAM fields. Given the time constraints of my PhD project, performance is no longer the only concern. Multiple factors, including code maintainability, must be taken into account.&#34;
"><link rel=preload href=/MeshFreeFoam-Docs/scss/main.min.82405bd70688c051c67c90adc004e04dfb6e0d6e3662ea9ed492379d237d683c.css as=style><link href=/MeshFreeFoam-Docs/scss/main.min.82405bd70688c051c67c90adc004e04dfb6e0d6e3662ea9ed492379d237d683c.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<link rel=stylesheet href=/MeshFreeFoam-Docs/css/prism.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-00000000-0")}</script></head><body class="td-page td-blog"><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/MeshFreeFoam-Docs/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>MeshFreeFoam API Docs</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/MeshFreeFoam-Docs/about/><span>About</span></a></li><li class=nav-item><a class=nav-link href=/MeshFreeFoam-Docs/docs/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/MeshFreeFoam-Docs/api/><span>MeshFreeFoam API</span></a></li><li class=nav-item><a class=nav-link href=/MeshFreeFoam-Docs/tests/><span>Unit Tests</span></a></li><li class=nav-item><a class="nav-link active" href=/MeshFreeFoam-Docs/blog/><span>Blog</span></a></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/MeshFreeFoam-Docs/offline-search-index.2869fb56695ec41d5a92963525235df2.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/MeshFreeFoam-Docs/offline-search-index.2869fb56695ec41d5a92963525235df2.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-meshfreefoam-docsblog-li><a href=/MeshFreeFoam-Docs/blog/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-meshfreefoam-docsblog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-meshfreefoam-docsblogdiscussions-li><input type=checkbox id=m-meshfreefoam-docsblogdiscussions-check checked>
<label for=m-meshfreefoam-docsblogdiscussions-check><a href=/MeshFreeFoam-Docs/blog/discussions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-meshfreefoam-docsblogdiscussions><span>Discussions</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230818the-very-first-issues-i-ran-into-with-this-documentation-project-li><input type=checkbox id=m-meshfreefoam-docsblog20230818the-very-first-issues-i-ran-into-with-this-documentation-project-check>
<label for=m-meshfreefoam-docsblog20230818the-very-first-issues-i-ran-into-with-this-documentation-project-check><a href=/MeshFreeFoam-Docs/blog/2023/08/18/the-very-first-issues-i-ran-into-with-this-documentation-project/ title="The very first issues I ran into with this documentation project" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230818the-very-first-issues-i-ran-into-with-this-documentation-project><span>First Issues</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230818managing-dependency-software-for-meshfreefoam-li><input type=checkbox id=m-meshfreefoam-docsblog20230818managing-dependency-software-for-meshfreefoam-check>
<label for=m-meshfreefoam-docsblog20230818managing-dependency-software-for-meshfreefoam-check><a href=/MeshFreeFoam-Docs/blog/2023/08/18/managing-dependency-software-for-meshfreefoam/ title="Managing dependency software for `meshfreeFoam`" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230818managing-dependency-software-for-meshfreefoam><span>meshfreeFoam dependencies</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230823design-of-domain-shapes-li><input type=checkbox id=m-meshfreefoam-docsblog20230823design-of-domain-shapes-check>
<label for=m-meshfreefoam-docsblog20230823design-of-domain-shapes-check><a href=/MeshFreeFoam-Docs/blog/2023/08/23/design-of-domain-shapes/ title="Design of domain shapes" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230823design-of-domain-shapes><span>Domain shapes</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230828runtime-selection-mechanism-for-meshfreefoam-li><input type=checkbox id=m-meshfreefoam-docsblog20230828runtime-selection-mechanism-for-meshfreefoam-check>
<label for=m-meshfreefoam-docsblog20230828runtime-selection-mechanism-for-meshfreefoam-check><a href=/MeshFreeFoam-Docs/blog/2023/08/28/runtime-selection-mechanism-for-meshfreefoam/ title="Runtime selection mechanism for `MeshFreeFoam`" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230828runtime-selection-mechanism-for-meshfreefoam><span>Runtime selection</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230829introducing-unit-tests-with-foamut-li><input type=checkbox id=m-meshfreefoam-docsblog20230829introducing-unit-tests-with-foamut-check>
<label for=m-meshfreefoam-docsblog20230829introducing-unit-tests-with-foamut-check><a href=/MeshFreeFoam-Docs/blog/2023/08/29/introducing-unit-tests-with-foamut/ title="Introducing unit tests with foamUT" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230829introducing-unit-tests-with-foamut><span>FoamUT Unit tests</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230829optimization-notes-part-1-li><input type=checkbox id=m-meshfreefoam-docsblog20230829optimization-notes-part-1-check>
<label for=m-meshfreefoam-docsblog20230829optimization-notes-part-1-check><a href=/MeshFreeFoam-Docs/blog/2023/08/29/optimization-notes-part-1/ title="Optimization notes: Part 1" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230829optimization-notes-part-1><span>Optimization notes 1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-meshfreefoam-docsblog20230927lazy-evaluation-part-1-li><input type=checkbox id=m-meshfreefoam-docsblog20230927lazy-evaluation-part-1-check checked>
<label for=m-meshfreefoam-docsblog20230927lazy-evaluation-part-1-check><a href=/MeshFreeFoam-Docs/blog/2023/09/27/lazy-evaluation-part-1/ title="Lazy Evaluation: Part 1" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230927lazy-evaluation-part-1><span class=td-sidebar-nav-active-item>Lazy evaluation 1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230929a-reflection-system-for-meshfreefoam-part-1-li><input type=checkbox id=m-meshfreefoam-docsblog20230929a-reflection-system-for-meshfreefoam-part-1-check>
<label for=m-meshfreefoam-docsblog20230929a-reflection-system-for-meshfreefoam-part-1-check><a href=/MeshFreeFoam-Docs/blog/2023/09/29/a-reflection-system-for-meshfreefoam-part-1/ title="A reflection system for MeshFreeFoam: Part 1" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230929a-reflection-system-for-meshfreefoam-part-1><span>Reflections for MeshFreeFoam 1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20231002a-reflection-system-for-meshfreefoam-part-2-li><input type=checkbox id=m-meshfreefoam-docsblog20231002a-reflection-system-for-meshfreefoam-part-2-check>
<label for=m-meshfreefoam-docsblog20231002a-reflection-system-for-meshfreefoam-part-2-check><a href=/MeshFreeFoam-Docs/blog/2023/10/02/a-reflection-system-for-meshfreefoam-part-2/ title="A reflection system for MeshFreeFoam: Part 2" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20231002a-reflection-system-for-meshfreefoam-part-2><span>Reflections for MeshFreeFoam 2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20231005a-reflection-system-for-meshfreefoam-part-3-li><input type=checkbox id=m-meshfreefoam-docsblog20231005a-reflection-system-for-meshfreefoam-part-3-check>
<label for=m-meshfreefoam-docsblog20231005a-reflection-system-for-meshfreefoam-part-3-check><a href=/MeshFreeFoam-Docs/blog/2023/10/05/a-reflection-system-for-meshfreefoam-part-3/ title="A reflection system for MeshFreeFoam: Part 3" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20231005a-reflection-system-for-meshfreefoam-part-3><span>Reflections for MeshFreeFoam 3</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-meshfreefoam-docsblognews-li><input type=checkbox id=m-meshfreefoam-docsblognews-check>
<label for=m-meshfreefoam-docsblognews-check><a href=/MeshFreeFoam-Docs/blog/news/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-meshfreefoam-docsblognews><span>News</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230819easy-api-documentation-with-hugo-and-hyde-li><input type=checkbox id=m-meshfreefoam-docsblog20230819easy-api-documentation-with-hugo-and-hyde-check>
<label for=m-meshfreefoam-docsblog20230819easy-api-documentation-with-hugo-and-hyde-check><a href=/MeshFreeFoam-Docs/blog/2023/08/19/easy-api-documentation-with-hugo-and-hyde/ title="Easy API documentation with Hugo and Hyde" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230819easy-api-documentation-with-hugo-and-hyde><span>Announcing APIDocs</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-meshfreefoam-docsblogreleases-li><input type=checkbox id=m-meshfreefoam-docsblogreleases-check>
<label for=m-meshfreefoam-docsblogreleases-check><a href=/MeshFreeFoam-Docs/blog/releases/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-meshfreefoam-docsblogreleases><span>Releases</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-meshfreefoam-docsblog20230819no-releases-li><input type=checkbox id=m-meshfreefoam-docsblog20230819no-releases-check>
<label for=m-meshfreefoam-docsblog20230819no-releases-check><a href=/MeshFreeFoam-Docs/blog/2023/08/19/no-releases/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-meshfreefoam-docsblog20230819no-releases><span>No Releases?</span></a></label></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/FoamScience/MeshFreeFoam-Docs/tree/main/content/en/blog/discussions/007-lazy-evaluation-part-1/index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/FoamScience/MeshFreeFoam-Docs/edit/main/content/en/blog/discussions/007-lazy-evaluation-part-1/index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page (not the frontmatter!)</a>
<a href="https://github.com/FoamScience/MeshFreeFoam-Docs/new/main/content/en/blog/discussions/007-lazy-evaluation-part-1/index.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/FoamScience/MeshFreeFoam-Docs/issues/new?title=Lazy%20Evaluation:%20Part%201" class=td-page-meta--issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/FoamScience/MeshFreeFoam/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#motivation>Motivation</a></li><li><a href=#lazy-evaluation-with-expression-templates>Lazy evaluation with expression templates</a></li><li><a href=#lazy-evaluation-with-views>Lazy evaluation with views</a></li><li><a href=#the-benchmarks>The benchmarks</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Tag Cloud</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/#nanoflannkdtreetests/ data-taxonomy-term=#nanoflannkdtreetests><span class=taxonomy-label>#nanoflannKDTreeTests</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/#trisurfaceshapetests/ data-taxonomy-term=#trisurfaceshapetests><span class=taxonomy-label>#triSurfaceShapeTests</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/advectiondiffusion/ data-taxonomy-term=advectiondiffusion><span class=taxonomy-label>advectionDiffusion</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/c++/ data-taxonomy-term=c++><span class=taxonomy-label>c++</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/dependency/ data-taxonomy-term=dependency><span class=taxonomy-label>dependency</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/docs/ data-taxonomy-term=docs><span class=taxonomy-label>docs</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/documentation/ data-taxonomy-term=documentation><span class=taxonomy-label>documentation</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/git/ data-taxonomy-term=git><span class=taxonomy-label>git</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/gui/ data-taxonomy-term=gui><span class=taxonomy-label>gui</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/hyde/ data-taxonomy-term=hyde><span class=taxonomy-label>hyde</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/meshfreefoam/ data-taxonomy-term=meshfreefoam><span class=taxonomy-label>meshfreeFoam</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/openfoam/ data-taxonomy-term=openfoam><span class=taxonomy-label>openfoam</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/performance/ data-taxonomy-term=performance><span class=taxonomy-label>performance</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/quality-of-life/ data-taxonomy-term=quality-of-life><span class=taxonomy-label>quality-of-life</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/sample/ data-taxonomy-term=sample><span class=taxonomy-label>sample</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/serial/ data-taxonomy-term=serial><span class=taxonomy-label>serial</span><span class=taxonomy-count>2</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/categories/examples/ data-taxonomy-term=examples><span class=taxonomy-label>Examples</span><span class=taxonomy-count>2</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-contributors"><h5 class=taxonomy-title>Contributors</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/contributors/__missing__/ data-taxonomy-term=missing><span class=taxonomy-label>&lt;Missing></span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/contributors/elwardi/ data-taxonomy-term=mohammed-elwardi-fadeli><span class=taxonomy-label>Mohammed Elwardi Fadeli</span><span class=taxonomy-count>6</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-api_tags"><h5 class=taxonomy-title>API Tags</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/api_tags/library/ data-taxonomy-term=library><span class=taxonomy-label>library</span><span class=taxonomy-count>1</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><a class=td-rss-button title=RSS href=https://foamscience.github.io/MeshFreeFoam-Docs/blog/discussions/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><div class=td-content><h1>Lazy Evaluation: Part 1</h1><div class=lead>In this short post, I examine the feasibility of implementing lazily-evaluated operations for MeshFreeFoam, contrasting them with the default eager evaluation used for OpenFOAM fields. Given the time constraints of my PhD project, performance is no longer the only concern. Multiple factors, including code maintainability, must be taken into account."</div><div class="td-byline mb-4">By <b>Mohammed Elwardi Fadeli (<a href=https://www.linkedin.com/in/elwardi-fadeli>@elwardi</a>)</b> |
<time datetime=2023-09-27 class=text-muted>Wednesday, September 27, 2023</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/c++/ data-taxonomy-term=c++><span class=taxonomy-label>c++</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/performance/ data-taxonomy-term=performance><span class=taxonomy-label>performance</span></a></li><li><a class=taxonomy-term href=https://foamscience.github.io/MeshFreeFoam-Docs/tags/openfoam/ data-taxonomy-term=openfoam><span class=taxonomy-label>openfoam</span></a></li></ul></div><p class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>&nbsp; 6 minute read &nbsp;</p></header><div style=position:relative;padding-bottom:56.25%><iframe style=width:100%;height:100%;position:absolute;left:0;top:0 frameborder=0 width=100% height=100% allowfullscreen allow=autoplay src=./LazyEvaluationAnimation.html></iframe></div><h2 id=motivation>Motivation</h2><p>I used to think of OpenFOAM&rsquo;s <code>tmp</code> class template as a memory management thing (which is correct). After having some suspicions, I had a discussion with <a href=https://www.linkedin.com/in/holger-marschall-62175683/>@holger</a> on the details of using <code>tmp</code> to get things out of function scope. As I&rsquo;ve skimmed through the code, I started to think of it as a lazy evaluation thing (which is not true). The main reason was that I would encounter operations of this signature <code>tmp&lt;T> BINARY_FUNCTION(T vf1, T vf2)</code> more and more.</p><p>So, I went and added Info statements to the fields constructors, and discovered that</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>a <span style=color:#333>=</span> b <span style=color:#333>+</span> c <span style=color:#333>+</span> d; <span style=color:#888>// as fields
</span></span></span></code></pre></div><p>would not construct two (from eagerly-doing the plus operations) but just one temporary object is created. This tricked me into thinking that those operations are done lazily. In fact, The same memory is reused for both operations, which does save up on memory allocation, but memory reads/writes still get carried out at the same spots as in traditional eager evaluation.</p><p>It seems that <code>tmp</code> was originally designed to optimize memory handling which has improved a lot in newer C++ standards. A recent C++ compiler performs move construction/assignment on return statements instead of copying which makes <code>tmp</code> redundant in this regard:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#888>// Assume Field&lt;scalar&gt; has a move constructor and assignment operator
</span></span></span><span style=display:flex><span><span style=color:#888></span>scalarField <span style=color:#06b;font-weight:700>add</span>(<span style=color:#080;font-weight:700>const</span> scalarField<span style=color:#333>&amp;</span> a, <span style=color:#080;font-weight:700>const</span> scalarField<span style=color:#333>&amp;</span> b) {
</span></span><span style=display:flex><span>    <span style=color:#080;font-weight:700>return</span> a <span style=color:#333>+</span> b;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>scalarField <span style=color:#06b;font-weight:700>c</span>(add(a,b)); <span style=color:#888>// This will move-construct c from result of a+b
</span></span></span><span style=display:flex><span><span style=color:#888>// Older compilers will do a copy; that&#39;s why most functions return a tmp
</span></span></span></code></pre></div><p>Thus, <code>tmp</code> has nothing to do with lazy evaluation, but computing linear combinations of stuff is all we do in CFD, and MeshFreeFoam is no exception. Being able to compute ${\bf x_1} + a {\bf x_2}$ efficiently is crucial. Here is the landscape of how efficient we can be:</p><ul><li>Regular C++: compute $a {\bf x_2}$ then add it to ${\bf x_1}$. Which is too wasteful (keeps allocating and discarding temporary memory chunks).</li><li>With OpenFOAM&rsquo;s <code>tmp</code>: saves on new memory allocation on addition but is still wasteful when it comes to CPU cycles.</li><li><strong>(?)</strong> With lazy evaluation: perform operations only when needed and at the tightest memory scope possible.</li></ul><p>Despite being a .Net language, F# (and most of other functional languages) nailed on-demand computation. In an attempt to bring that level of functionality to my PhD project, I investigate how would lazy evaluation be implemented for OpenFOAM-based code.</p><h2 id=lazy-evaluation-with-expression-templates>Lazy evaluation with expression templates</h2><p>The first candidate was expression templates. I have heard of this concept countless times before. I even had my own my matrix implementation that allowed to perform operations only on a subset of rows/columns lazily. While that is not so useful now, being familiar with the concept helps. Also, with C++17 and newer standards, the implementation of expression templates has become much easier compared to five or six years back.</p><p>One inherent drawback of a rigorous implementation of expression templates is that they can add some considerable complexity to the code in regard of ordering computations:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#888>// Assume &lt;&lt;, +  and * are implemented with expression templates
</span></span></span><span style=display:flex><span><span style=color:#888></span>a <span style=color:#333>&lt;&lt;</span> b <span style=color:#333>+</span> c; <span style=color:#888>// using &lt;&lt; to denote that this is not an assignment; take it as a mere labeling operation
</span></span></span><span style=display:flex><span><span style=color:#888>// a not used, so, let&#39;s not compute it yet
</span></span></span><span style=display:flex><span><span style=color:#888></span>b <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>; <span style=color:#888>// now this is an assignment
</span></span></span><span style=display:flex><span><span style=color:#888></span>d <span style=color:#333>&lt;&lt;</span> a <span style=color:#333>*</span> <span style=color:#00d;font-weight:700>2</span>; <span style=color:#888>// Which values of b were used here? b = 1; but was that intended?
</span></span></span></code></pre></div><p>That said, the performance benefit of implementing expression templates is enormous. It&rsquo;s at least 50% faster than eager evaluation for <a href=https://github.com/FoamScience/Eager-TemplateExpr-Views-OpenFOAM/blob/80c59112d5660cd24630e4c57c6f7648c8a0b8c7/expressionTemplatesVsViewsTests.C#L30>few operations</a> (addition, multiplication, subtraction and division of scalar arrays).</p><p>Thus, the next best thing, is a partial template expression system which evaluates on assignment to avoid the confusion, so not truly lazy, but somewhere in between. Even then, I will have to maintain the whole system while keeping it compatible with OpenFOAM&rsquo;s API. Instead, I started to look at the news ranges from C++20 standard library.</p><h2 id=lazy-evaluation-with-views>Lazy evaluation with views</h2><p>In particular, C++20 introduces <code>views</code> which are special kinds of ranges which do not own their data. For our purposes, think of them as views into (parts of) the CFD fields. These were perfect for other purposes too, for example, implementation of fit-in-L2-cache subdomains for MeshFreeFoam.</p><p>The biggest problem with views is the thin compiler support. For example, to use <code>zip_transform</code> which allows to do operations on multiple views at one (eg. binary functions), we have to use at least GCC 13 and link against C++23.</p><p>The performance benefits are very close to what expression templates provide; at much less maintainability cost; but the uncertainty around them is much higher because of the thin support.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>NVIDIA&rsquo;s HPC c++ compilers at the moment support only C++17; <a href=https://developer.nvidia.com/blog/accelerating-standard-c-with-gpus-using-stdpar/>using stdpar</a> will prove difficult if decided to use views. So, for now, it&rsquo;s either to optimize for CPU; <strong>or</strong> use the GPU. We can&rsquo;t do both as working comfortably with views requires C++23.</div><p>Thus, building a system on top of views is probably not a good idea when it comes to API stability. But there is always the <a href=https://github.com/ericniebler/range-v3>ranges-v3</a> library which will hopefully cover anything that the standard libraries might miss. My only concern is that I will not have enough time to wait for standard updates; if anything is missing in c++23 standard library, I will have to switch to <code>ranges-v3</code> for quite some time or ditch the idea.</p><h2 id=the-benchmarks>The benchmarks</h2><p>You can take a look at the benchmark results at <a href=https://github.com/FoamScience/Eager-TemplateExpr-Views-OpenFOAM/actions/runs/6332376505/job/17198740304>this dedicated repository</a> (at the end of compile and test step) which reflect what is shown in the animation above (<code>m</code>, <code>rho</code>, &mldr;, etc are all scalar fields). The CI workflows there perform the benchmarks on Github machines (which are not the fastest) so, compared to HPC nodes, results are a little exaggerated.</p><p>The correctness and performance of the testing code are recorded by <a href=https://github.com/FoamScience/foamUT>foamUT</a>; my unit-testing framework for OpenFOAM code (hence MeshFreeFoam too).</p><p>For the sake of exploring the effects of template expressions, I stole and used a <a href=https://gieseanw.wordpress.com/2019/10/20/we-dont-need-no-stinking-expression-templates/>trivial implementation</a>:</p><div class="td-card card border me-4"><div class="card-header bg-white">Template expression for binary operations on containers in C++</div><div class="card-body code p-0 m-0"><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CPP data-lang=CPP><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-weight:700>template</span><span style=color:#333>&lt;</span><span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>T</span>, <span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>U</span>, <span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>Callable</span><span style=color:#333>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-weight:700>struct</span> <span style=color:#b06;font-weight:700>BinaryContainerExpression</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#080;font-weight:700>template</span><span style=color:#333>&lt;</span><span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>Func</span><span style=color:#333>&gt;</span>
</span></span><span style=display:flex><span>    BinaryContainerExpression(<span style=color:#080;font-weight:700>const</span> T<span style=color:#333>&amp;</span> _left, <span style=color:#080;font-weight:700>const</span> U<span style=color:#333>&amp;</span> _right, Func<span style=color:#333>&amp;&amp;</span> _callable) <span style=color:#333>:</span>
</span></span><span style=display:flex><span>    left_{<span style=color:#333>&amp;</span>_left},
</span></span><span style=display:flex><span>    right_{<span style=color:#333>&amp;</span>_right},
</span></span><span style=display:flex><span>    callable_{std<span style=color:#333>::</span>forward<span style=color:#333>&lt;</span>Func<span style=color:#333>&gt;</span>(_callable)}
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        assert(_left.size() <span style=color:#333>==</span> _right.size());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#080;font-weight:700>auto</span> <span style=color:#080;font-weight:700>operator</span>[](size_t index) <span style=color:#080;font-weight:700>const</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#080;font-weight:700>return</span> <span style=color:#06b;font-weight:700>callable_</span>((<span style=color:#333>*</span>left_)[index], (<span style=color:#333>*</span>right_)[index]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    size_t <span style=color:#06b;font-weight:700>size</span>() <span style=color:#080;font-weight:700>const</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#080;font-weight:700>return</span> left_<span style=color:#333>-&gt;</span>size();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#080;font-weight:700>const</span> T<span style=color:#333>*</span> left_<span style=color:#333>=</span> <span style=color:#080;font-weight:700>nullptr</span>;
</span></span><span style=display:flex><span>    <span style=color:#080;font-weight:700>const</span> U<span style=color:#333>*</span> right_<span style=color:#333>=</span> <span style=color:#080;font-weight:700>nullptr</span>;
</span></span><span style=display:flex><span>    Callable callable_;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></div><div class=card-footer>Not suitable for production code. I&rsquo;m sure I can add syntactic sugar, but that&rsquo;s not the point.</div></div><p>It&rsquo;s worth noting that on <a href=https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources>GitHub machines</a> the execution time of lazy evaluations is a third of that of eager evaluations; while on my local machine, it&rsquo;s around 50%. For the record, the test machine has the following properties:</p><pre tabindex=0><code>System:    Kernel: 5.15.0-10078* x86_64 bits: 64 compiler: N/A Desktop: Gnome 3.36.9 
           Distro: Ubuntu 20.04.6 LTS (Focal Fossa) 
CPU:       Topology: 8-Core model: AMD Ryzen 7 5800H with Radeon Graphics bits: 64 type: MT MCP arch: Zen 3 L2 cache: 4096 KiB 
           flags: avx avx2 lm nx pae sse sse2 sse3 sse4_1 sse4_2 sse4a ssse3 svm bogomips: 102207 
           Speed: 1254 MHz min/max: 1200/3200 MHz Core speeds (MHz): 1: 1275 2: 1191 3: 1139 4: 1227 5: 1134 6: 1135 7: 1297 
           8: 1296 9: 1135 10: 1135 11: 1135 12: 1133 13: 1286 14: 1171 15: 1517 16: 1161 
</code></pre><h2 id=conclusion>Conclusion</h2><p>If GPU acceleration is not important, <code>Views</code> are the best course of action. This idea might fail horribly though, as everything else.</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/MeshFreeFoam-Docs/blog/2023/09/29/a-reflection-system-for-meshfreefoam-part-1/ aria-label="Previous - A reflection system for MeshFreeFoam: Part 1" class="btn btn-primary"><span class=me-1>←</span>Previous</a></li><li><a href=/MeshFreeFoam-Docs/blog/2023/08/29/optimization-notes-part-1/ aria-label="Next - Optimization notes: Part 1" class="btn btn-primary">Next<span class=ms-1>→</span></a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Discord server" aria-label="Discord server"><a target=_blank rel=noopener href=https://discord/invitation/link aria-label="Discord server"><i class="fab fa-discord"></i></a></li></ul></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/FoamScience/MeshFreeFoam aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://example.org/slack aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2024 Mohammed Elwardi Fadeli All Rights Reserved</span>
<span class=ms-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span><p class="td-footer__about mt-2"><a href=/MeshFreeFoam-Docs/about/>About APIDocs</a></p></div></div></div></footer></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g==" crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"},{display:!0,left:"\\[",right:"\\]"}],errorcolor:"#CD5C5C",throwonerror:!0})'></script><script src=/MeshFreeFoam-Docs/js/main.min.99abe30f7fb05785a480d405ee1665ebd520cec6bbadffe966b7737e103675b8.js integrity="sha256-mavjD3+wV4WkgNQF7hZl69Ugzsa7rf/pZrdzfhA2dbg=" crossorigin=anonymous></script>
<script src=/MeshFreeFoam-Docs/js/prism.js></script>
<script src=/MeshFreeFoam-Docs/js/tabpane-persist.js></script></body></html>